#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ç­–ç•¥BæŠ¥å‘Šç”Ÿæˆå™¨
"""

import sys
import os
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

import pandas as pd
from datetime import datetime
from src.notification import NotificationService
import logging

logging.basicConfig(level=logging.INFO, format='%(message)s')
logger = logging.getLogger(__name__)


def generate_oversold_report(csv_file: str, push_to_wechat: bool = False):
    """ç”Ÿæˆç­–ç•¥Bæ‰«ææŠ¥å‘Š"""
    
    # è¯»å–æ•°æ®
    df = pd.read_csv(csv_file)
    
    # åˆ†çº§
    high_score = df[df['oversold_score'] >= 7].sort_values('oversold_score', ascending=False)
    medium_score = df[(df['oversold_score'] >= 5) & (df['oversold_score'] < 7)].sort_values('oversold_score', ascending=False)
    
    today = datetime.now().strftime('%Y-%m-%d %H:%M')
    
    # ç”ŸæˆMarkdownæŠ¥å‘Š
    report_lines = [
        f"# ğŸ“Š ç­–ç•¥Bï¼šé»„é‡‘å‘åå¼¹æ‰«ææŠ¥å‘Š",
        "",
        f"**æŠ¥å‘Šæ—¶é—´**: {today}",
        f"**æ‰«ææ€»æ•°**: 6796 åªè‚¡ç¥¨",
        f"**ç¬¦åˆåŸºç¡€æ¡ä»¶**: {len(df)} åª",
        "",
        "---",
        "",
        "## ğŸŒ å¸‚åœºç¯å¢ƒ",
        "",
        "ã€ğŸ“Š å¸‚åœºç¯å¢ƒã€‘: **10/10 åˆ†** ğŸŸ¢ **ç»¿ç¯**",
        "",
        "ã€ğŸ’¡ ç­–ç•¥é€‰æ‹©ã€‘: è™½ç„¶å¤§ç›˜ç»¿ç¯ï¼ˆé€‚åˆç­–ç•¥Aï¼‰ï¼Œä½†ç­–ç•¥Bå¯ç”¨äºï¼š",
        "- å¯»æ‰¾**é”™æ€è‚¡**ï¼ˆåŸºæœ¬é¢è‰¯å¥½ä½†æŠ€æœ¯é¢è¶…è·Œï¼‰",
        "- **åå‘æ“ä½œ**ï¼ˆé€†å‘æ€ç»´ï¼Œä½å¸é«˜æŠ›ï¼‰",
        "- **ä»“ä½é…ç½®**ï¼ˆ10-20%ä»“ä½åšå–è¶…è·Œåå¼¹ï¼‰",
        "",
        "> [!WARNING]",
        "> ç­–ç•¥Bé£é™©è¾ƒé«˜ï¼Œé€‚åˆæœ‰ç»éªŒçš„æŠ•èµ„è€…ã€‚å¤§ç›˜ç»¿ç¯æ—¶åº”ä»¥ç­–ç•¥Aä¸ºä¸»ã€‚",
        "",
        "---",
        "",
        "## ğŸ“Š æ‰«æç»“æœæ±‡æ€»",
        "",
        f"- ğŸ† **é«˜åˆ†è¶…è·Œ** (7-10åˆ†): **{len(high_score)} åª**",
        f"- ğŸ“ˆ **ä¸­åº¦è¶…è·Œ** (5-6åˆ†): **{len(medium_score)} åª**",
        "",
    ]
    
    if len(high_score) == 0:
        report_lines.extend([
            "---",
            "",
            "## âš ï¸ é‡è¦æç¤º",
            "",
            "**å½“å‰å¸‚åœºæœªå‘ç°é«˜åˆ†è¶…è·Œè‚¡ï¼ˆ7-10åˆ†ï¼‰**",
            "",
            "å¯èƒ½åŸå› ï¼š",
            "1. å¤§ç›˜å¤„äºç»¿ç¯çŠ¶æ€ï¼Œæ•´ä½“ä¸Šæ¶¨",
            "2. å¸‚åœºæƒ…ç»ªè¾ƒå¥½ï¼Œç¼ºä¹æ·±åº¦å›è°ƒ",
            "3. è¶…è·Œè‚¡è¾ƒå°‘æˆ–å·²è¢«å¸‚åœºæ¶ˆåŒ–",
            "",
            "å»ºè®®ï¼š",
            "- **ä¼˜å…ˆä½¿ç”¨ç­–ç•¥A**ï¼ˆå…­ç»´çœŸå¼ºåŠ¿ï¼‰è¿½æ¶¨å¼ºåŠ¿è‚¡",
            "- ç­–ç•¥Bä»…ä½œä¸º**è¾…åŠ©å‚è€ƒ**ï¼Œå°ä»“ä½åšå–åå¼¹",
            "- ç­‰å¾…å¤§ç›˜è½¬ä¸º**é»„ç¯æˆ–çº¢ç¯**æ—¶å†é‡ç‚¹å…³æ³¨ç­–ç•¥B",
            "",
        ])
    else:
        report_lines.extend([
            "---",
            "",
            "## ğŸ† é«˜åˆ†è¶…è·Œè‚¡æ¨è",
            "",
        ])
        
        for i, row in enumerate(high_score.head(20).iterrows(), 1):
            stock = row[1]
            
            report_lines.extend([
                f"### {i}. {stock['name']}({stock['code']}) - {int(stock['oversold_score'])}/10åˆ†",
                "",
                "**å…³é”®æ•°æ®**:",
                f"- ğŸ’° è‚¡ä»·: Â¥{stock['close']:.2f} | ä»Šæ—¥: {stock['change_pct']:+.2f}%",
                f"- ğŸ“‰ ä¹–ç¦»ç‡: **{stock['bias_20']:.1f}%** (è¿œç¦»MA20)",
                f"- ğŸ“Š RSI(6): **{stock['rsi_6']:.1f}** (è¶…å–åŒº)",
                f"- ğŸ“ˆ æˆäº¤é¢: {stock['turnover']/100000000:.2f}äº¿ | é‡æ¯”: {stock['volume_ratio']:.2f}x",
                "",
                "**è¶…è·Œè¯„åˆ†è¯¦æƒ…**:",
            ])
            
            import ast
            try:
                details = ast.literal_eval(stock['oversold_details'])
                for dim, result in details.items():
                    report_lines.append(f"- {dim}: {result}")
            except:
                pass
            
            report_lines.extend([
                "",
                f"**æ“ä½œå»ºè®®**: å°ä»“ä½è¯•æ¢ï¼ˆ5-10%ï¼‰ï¼Œæ­¢æŸä½-5%",
                "",
                "---",
                "",
            ])
    
    # ä¸­åº¦è¶…è·Œè‚¡
    if len(medium_score) > 0:
        report_lines.extend([
            "## ğŸ“ˆ ä¸­åº¦è¶…è·Œè‚¡åˆ—è¡¨ (5-6åˆ†)",
            "",
            "*å¤‡é€‰æ± ï¼šé€‚åº¦è¶…è·Œï¼Œå¯å…³æ³¨åå¼¹æœºä¼š*",
            "",
            "| æ’å | è‚¡ç¥¨åç§° | ä»£ç  | è¯„åˆ† | ä¹–ç¦»ç‡ | RSI | ä»Šæ—¥æ¶¨å¹… |",
            "|------|---------|------|------|--------|-----|---------|",
        ])
        
        for i, row in enumerate(medium_score.iterrows(), 1):
            stock = row[1]
            report_lines.append(
                f"| {i} | {stock['name']} | {stock['code']} | "
                f"{int(stock['oversold_score'])}/10 | {stock['bias_20']:.1f}% | "
                f"{stock['rsi_6']:.1f} | {stock['change_pct']:+.2f}% |"
            )
    
    report_lines.extend([
        "",
        "---",
        "",
        "## ğŸ’¡ ç­–ç•¥è¯´æ˜",
        "",
        "### ğŸ›¡ï¸ ç­–ç•¥Bï¼šé»„é‡‘å‘åå¼¹ (Oversold Bounce)",
        "",
        "*é€‚ç”¨åœºæ™¯ï¼šè‚¡ä»·è¿ç»­ä¸‹è·Œï¼Œå¯»æ±‚è¶…è·Œåå¼¹æœºä¼š*",
        "",
        "**è¯„åˆ†æ ‡å‡†** (æ€»åˆ†10åˆ†):",
        "",
        "1. **ä¹–ç¦»ç‡** (0-3åˆ†): è‚¡ä»·è¿œç¦»MA20",
        "   - < -20%: ä¸¥é‡è¶…è·Œ (+3åˆ†)",
        "   - < -15%: æ˜æ˜¾è¶…è·Œ (+2åˆ†)",
        "   - < -10%: è½»åº¦è¶…è·Œ (+1åˆ†)",
        "",
        "2. **RSIæŒ‡æ ‡** (0-3åˆ†): è¶…å–ç¨‹åº¦",
        "   - < 20: æåº¦è¶…å– (+3åˆ†)",
        "   - < 30: è¶…å– (+2åˆ†)",
        "   - < 40: åå¼± (+1åˆ†)",
        "",
        "3. **Kçº¿å½¢æ€** (0-2åˆ†):",
        "   - é‡‘é’ˆæ¢åº•ï¼ˆé•¿ä¸‹å½±>50%ï¼‰(+2åˆ†)",
        "   - Vå‹åè½¬ï¼ˆå¤§æ¶¨>3%ï¼‰(+2åˆ†)",
        "   - é˜³çº¿åå¼¹ (+1åˆ†)",
        "",
        "4. **é‡èƒ½** (0-1åˆ†):",
        "   - çªç„¶æ”¾é‡ (é‡æ¯”>1.5) (+1åˆ†)",
        "",
        "5. **å¸ƒæ—å¸¦ä½ç½®** (0-1åˆ†):",
        "   - è§¦åŠä¸‹è½¨ (+1åˆ†)",
        "",
        "**è¯„çº§æ ‡å‡†**:",
        "- **é«˜åˆ†è¶…è·Œ** (7-10åˆ†): æåº¦è¶…è·Œï¼Œåå¼¹æ¦‚ç‡å¤§",
        "- **ä¸­åº¦è¶…è·Œ** (5-6åˆ†): é€‚åº¦è¶…è·Œï¼Œå¯å…³æ³¨",
        "",
        "---",
        "",
        "## ğŸ›¡ï¸ é£æ§æç¤ºï¼ˆé‡è¦ï¼ï¼‰",
        "",
        "> [!CAUTION]",
        "> ç­–ç•¥Bé£é™©ç­‰çº§ï¼š**é«˜é£é™©**",
        "",
        "1. **ä¸¥æ ¼æ­¢æŸ**: -5%æˆ–è·Œç ´å‰ä½ç«‹å³æ­¢æŸ",
        "2. **å°ä»“ä½**: å•åªâ‰¤10%ï¼Œæ€»ä»“ä½â‰¤20%",
        "3. **åˆ†æ‰¹å»ºä»“**: åˆ†2-3æ¬¡è¿›åœºï¼Œä¸è¦ä¸€æ¬¡æ€§æ»¡ä»“",
        "4. **å¿«è¿›å¿«å‡º**: åå¼¹5-10%åŠæ—¶æ­¢ç›ˆ",
        "5. **åŸºæœ¬é¢æ’é›·**:",
        "   - âŒ é¿å¼€STè‚¡ç¥¨",
        "   - âŒ é¿å¼€è´¢åŠ¡é€ å‡é£é™©",
        "   - âŒ é¿å¼€é€€å¸‚é£é™©",
        "6. **å¸‚åœºç¯å¢ƒ**:",
        "   - ğŸŸ¢ ç»¿ç¯æ—¶ï¼šç­–ç•¥Bä»…ä½œè¾…åŠ©ï¼ˆ10-20%ä»“ä½ï¼‰",
        "   - ğŸŸ¡ é»„ç¯æ—¶ï¼šç­–ç•¥Bå¯é€‚åº¦åŠ å¤§ï¼ˆ30-40%ä»“ä½ï¼‰",
        "   - ğŸ”´ çº¢ç¯æ—¶ï¼šç©ºä»“è§‚æœ›ï¼Œä¸æŠ„åº•",
        "",
        "---",
        "",
        "## ğŸ“Š ç­–ç•¥å¯¹æ¯”",
        "",
        "| ç»´åº¦ | ç­–ç•¥Aï¼ˆå…­ç»´çœŸå¼ºåŠ¿ï¼‰ | ç­–ç•¥Bï¼ˆé»„é‡‘å‘åå¼¹ï¼‰ |",
        "|------|-------------------|-------------------|",
        "| é€‚ç”¨ç¯å¢ƒ | ğŸŸ¢ å¤§ç›˜ç»¿ç¯ | ğŸŸ¡ å¤§ç›˜é»„ç¯ |",
        "| é£é™©ç­‰çº§ | ä¸­é£é™© | **é«˜é£é™©** |",
        "| å»ºè®®ä»“ä½ | 60-80% | 10-20% |",
        "| æŒä»“å‘¨æœŸ | ä¸­é•¿çº¿ï¼ˆ1-4å‘¨ï¼‰ | çŸ­çº¿ï¼ˆ3-7å¤©ï¼‰ |",
        "| æ­¢æŸç­–ç•¥ | è·Œç ´MA5 | **è·Œç ´å‰ä½æˆ–-5%** |",
        "| ä»Šæ—¥ç»“æœ | **50åªSçº§** | 22åªä¸­åº¦è¶…è·Œ |",
        "",
        "---",
        "",
        f"**æ•°æ®æ¥æº**: yfinance API",
        f"**åˆ†ææ—¶é—´**: {today}",
        f"**ç­–ç•¥ç‰ˆæœ¬**: v1.0",
    ])
    
    report = "\n".join(report_lines)
    
    # ä¿å­˜æŠ¥å‘Š
    report_file = f'data/oversold_report_{datetime.now().strftime("%Y-%m-%d")}.md'
    with open(report_file, 'w', encoding='utf-8') as f:
        f.write(report)
    
    logger.info(f"âœ… æŠ¥å‘Šå·²ä¿å­˜: {report_file}")
    
    # å†³å®šæ˜¯å¦æ¨é€ï¼ˆç­–ç•¥Bä¸€èˆ¬ä¸ä¸»åŠ¨æ¨é€ï¼Œé™¤éæœ‰é«˜åˆ†è‚¡ç¥¨ï¼‰
    should_push = len(high_score) >= 3 and push_to_wechat
    
    if should_push:
        logger.info(f"\nğŸ“¤ å‡†å¤‡æ¨é€åˆ°ä¼ä¸šå¾®ä¿¡")
        # æ¨é€é€»è¾‘...
    else:
        logger.info(f"\nâš ï¸  æœªæ¨é€: å½“å‰å¸‚åœºè¶…è·Œè‚¡è¾ƒå°‘ï¼Œå»ºè®®å…³æ³¨ç­–ç•¥A")
    
    # è¾“å‡ºæ‘˜è¦
    logger.info("\n" + "="*70)
    logger.info("ğŸ“Š ç­–ç•¥BæŠ¥å‘Šæ‘˜è¦:")
    logger.info(f"   é«˜åˆ†è¶…è·Œ: {len(high_score)} åª")
    logger.info(f"   ä¸­åº¦è¶…è·Œ: {len(medium_score)} åª")
    logger.info(f"   è¯¦ç»†æŠ¥å‘Š: {report_file}")
    logger.info("")
    logger.info("ğŸ’¡ å»ºè®®: å¤§ç›˜ç»¿ç¯æ—¶ä»¥ç­–ç•¥Aä¸ºä¸»ï¼Œç­–ç•¥Bä»…ä½œè¾…åŠ©")
    logger.info("="*70)
    
    return report_file


if __name__ == "__main__":
    import argparse
    
    parser = argparse.ArgumentParser(description='ç”Ÿæˆç­–ç•¥Bæ‰«ææŠ¥å‘Š')
    parser.add_argument('--csv', default=f'data/oversold_bounce_scan_{datetime.now().strftime("%Y-%m-%d")}.csv',
                       help='CSVæ–‡ä»¶è·¯å¾„')
    parser.add_argument('--push', action='store_true', help='æ¨é€åˆ°ä¼ä¸šå¾®ä¿¡')
    
    args = parser.parse_args()
    
    generate_oversold_report(args.csv, push_to_wechat=args.push)
