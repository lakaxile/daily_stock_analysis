{% extends "base.html" %}

{% block title %}首页 - 股票分析系统{% endblock %}

{% block content %}
<div class="hero">
    <h2>🎯 六维真强势选股策略</h2>
    <p class="subtitle">技术扫描 + AI深度分析 = 精准选股</p>

    <!-- 股票搜索框 -->
    <div class="search-box">
        <input type="text" id="stockCode" placeholder="输入股票代码（如：600519、000001）" maxlength="6">
        <button onclick="analyzeStock()" class="btn-search">🔍 AI分析</button>
    </div>
    <p class="search-hint">支持沪深A股，实时获取K线数据+AI深度分析</p>
</div>

<!-- 分析结果展示区 -->
<div id="analysisResult" class="analysis-result" style="display:none;">
    <div class="card">
        <div class="result-header">
            <h3 id="resultTitle">分析结果</h3>
            <button onclick="closeResult()" class="btn-close">✕</button>
        </div>
        <div id="resultContent" class="result-content">
            <div class="loading">
                <div class="spinner"></div>
                <p>AI分析中...</p>
            </div>
        </div>
    </div>
</div>

<div class="dashboard">
    <div class="card">
        <h3>📅 最新选股 ({{ latest_date }})</h3>
        {% if picks %}
        <table class="stock-table" id="sixdim-table">
            <thead>
                <tr>
                    <th>股票代码</th>
                    <th>股票名称</th>
                    <th>技术评分</th>
                    <th>📈 实时涨跌</th>
                    <th>操作建议</th>
                    <th>详情</th>
                </tr>
            </thead>
            <tbody>
                {% for stock in picks %}
                <tr data-code="{{ stock.code }}">
                    <td><strong>{{ stock.code }}</strong></td>
                    <td>{{ stock.name }}</td>
                    <td><span class="badge badge-success">{{ stock.score }}/10</span></td>
                    <td class="live-change" id="live-{{ stock.code }}">
                        <span style="color: #888;">加载中...</span>
                    </td>
                    <td><span class="operation">{{ stock.operation_advice or '持有' }}</span></td>
                    <td><a href="/stock/{{ stock.code }}" class="btn btn-sm">查看</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="empty-state">暂无选股数据</p>
        {% endif %}
    </div>

    <!-- 美股联动选股 -->
    <div class="card">
        <h3>🌐 美股联动选股 ({{ us_latest_date or '暂无' }}) <a href="/us-strategy" style="font-size: 14px; float: right;">查看详情
                →</a></h3>
        {% if us_picks %}
        <table class="stock-table" id="us-table">
            <thead>
                <tr>
                    <th>股票代码</th>
                    <th>股票名称</th>
                    <th>现价</th>
                    <th>📈 实时涨跌</th>
                    <th>来源</th>
                    <th>详情</th>
                </tr>
            </thead>
            <tbody>
                {% for stock in us_picks %}
                <tr data-code="{{ stock.code }}">
                    <td><strong>{{ stock.code }}</strong></td>
                    <td>{{ stock.name }}</td>
                    <td class="live-price" id="price-{{ stock.code }}">¥{{ "%.2f"|format(stock.price) }}</td>
                    <td class="live-change" id="live-{{ stock.code }}">
                        <span style="color: #888;">加载中...</span>
                    </td>
                    <td><span class="badge" style="background: linear-gradient(135deg, #667eea, #764ba2);">{{
                            stock.reason }}</span></td>
                    <td><a href="/stock/{{ stock.code }}" class="btn btn-sm">查看</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="empty-state">暂无数据，策略将在每日 05:30 自动执行</p>
        {% endif %}
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">🎯</div>
            <div class="stat-content">
                <h4>选股数量</h4>
                <p class="stat-value">{{ picks|length }}</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">📊</div>
            <div class="stat-content">
                <h4>市场环境</h4>
                <p class="stat-value">偏弱</p>
                <p class="stat-desc">上证未站MA20</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">🤖</div>
            <div class="stat-content">
                <h4>AI分析</h4>
                <p class="stat-value">启用</p>
                <p class="stat-desc">DeepSeek Chat</p>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>🚀 策略特点</h3>
        <ul class="feature-list">
            <li>✅ <strong>市场环境过滤</strong>：大盘偏弱时自动拦截，避免逆势操作</li>
            <li>✅ <strong>六维技术评分</strong>：趋势、K线、量价、分时、盘口、尾盘综合打分</li>
            <li>✅ <strong>AI深度分析</strong>：每只股票经过AI风险评估和操作建议</li>
            <li>✅ <strong>动态调整</strong>：根据实盘表现持续优化策略</li>
        </ul>
    </div>

    <div class="card">
        <h3>📈 策略改进历程</h3>
        <div class="timeline">
            <div class="timeline-item">
                <div class="timeline-date">2026-02-06</div>
                <div class="timeline-content">
                    <h4>✅ 市场环境过滤器</h4>
                    <p>增加大盘环境检查，避免在弱势环境选股</p>
                </div>
            </div>
            <div class="timeline-item">
                <div class="timeline-date">2026-02-05</div>
                <div class="timeline-content">
                    <h4>📊 策略回顾与改进</h4>
                    <p>AI分析昨日选股全跌原因，提出5大改进建议</p>
                </div>
            </div>
            <div class="timeline-item">
                <div class="timeline-date">2026-02-05</div>
                <div class="timeline-content">
                    <h4>🤖 AI综合分析</h4>
                    <p>整合技术扫描结果，生成AI深度分析报告</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 实时行情自动刷新
    function fetchRealtimeQuotes() {
        const rows = document.querySelectorAll('tr[data-code]');
        if (!rows.length) return;

        const codes = [...new Set([...rows].map(r => r.dataset.code))];

        fetch('/api/realtime?codes=' + codes.join(','))
            .then(r => r.json())
            .then(data => {
                for (const [code, info] of Object.entries(data)) {
                    // 更新实时涨跌幅
                    const cell = document.getElementById('live-' + code);
                    if (cell) {
                        const color = info.change_pct > 0 ? '#4ecb71' : (info.change_pct < 0 ? '#ff6b6b' : '#ccc');
                        const arrow = info.change_pct > 0 ? '▲' : (info.change_pct < 0 ? '▼' : '—');
                        cell.innerHTML = `<span style="color:${color};font-weight:bold;">${arrow} ${info.change_pct > 0 ? '+' : ''}${info.change_pct.toFixed(2)}%</span><br><small style="color:#999;">¥${info.price.toFixed(2)}</small>`;
                    }
                    // 更新现价列 (US表)
                    const priceCell = document.getElementById('price-' + code);
                    if (priceCell) {
                        priceCell.textContent = '¥' + info.price.toFixed(2);
                    }
                }
                // 更新时间戳
                const ts = document.getElementById('realtime-ts');
                if (ts) ts.textContent = '最后更新: ' + new Date().toLocaleTimeString('zh-CN');
            })
            .catch(err => console.warn('实时行情获取失败:', err));
    }

    // 首次加载 + 每10秒刷新
    fetchRealtimeQuotes();
    setInterval(fetchRealtimeQuotes, 10000);
</script>
{% endblock %}